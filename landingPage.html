<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Selah</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  /* ── HIDE SCROLLBARS ── */
  ::-webkit-scrollbar { display: none; width: 0; background: transparent; }
  * { -ms-overflow-style: none; scrollbar-width: none; }

  :root {
    --bg: #F5F2EB;
    --text-dark: #322115;
    --text-muted: #8C7B6E;
    --input-bg: #FFFFFF;
    --input-stroke: #E2DFD8;
    --pill-border: #D8D3CC;
    --chat-user-bg: #E8E4D9;
    --chat-ai-text: #322115;
    --sidebar-bg: #EBE7DC; 
  }

  html, body {
    height: 100%;
    background: var(--bg);
    font-family: 'Inter', sans-serif;
    color: var(--text-dark);
    overflow: hidden; 
  }

  /* ── NAV ── */
  nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 48px;
    border-bottom: 1px solid rgba(0,0,0,0.04);
    background: var(--bg);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .nav-left {
    display: flex;
    align-items: center;
  }

  .menu-toggle {
    cursor: pointer;
    opacity: 0.6;
    margin-right: 16px;
    display: flex;
    align-items: center;
    transition: opacity 0.2s;
  }
  .menu-toggle:hover { opacity: 1; }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 19px;
    font-weight: 400;
    color: var(--text-dark);
    text-decoration: none;
  }

  .logo img {
    width: 36px;
    height: 36px;
    object-fit: contain;
    mix-blend-mode: multiply;
    display: block;
  }

  .chat-nav-title {
    display: none;
    align-items: center;
    gap: 10px;
    font-size: 16px;
    font-weight: 400;
    color: var(--text-dark);
    cursor: pointer;
  }

  .chat-nav-title svg {
    width: 12px;
    height: 12px;
    opacity: 0.6;
  }

  .nav-links {
    display: flex;
    gap: 32px;
    list-style: none;
  }

  .nav-links a {
    font-size: 15px;
    font-weight: 400;
    color: var(--text-dark);
    text-decoration: none;
    opacity: 0.9;
    transition: opacity 0.15s;
  }
  .nav-links a:hover { opacity: 1; }

  /* ── VIEWS ── */
  #home-view, #chat-view {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #home-view {
    justify-content: center;
    min-height: calc(100vh - 75px);
    padding-bottom: 120px;
  }

  #chat-view {
    display: none;
    height: calc(100vh - 75px);
    position: relative;
    width: 100%;
  }

  /* ── HOME ── */
  .greeting {
    font-size: 42px;
    font-weight: 400;
    color: var(--text-dark);
    margin-bottom: 40px;
    text-align: center;
    letter-spacing: -0.5px;
  }

  .input-wrapper {
    width: 720px;
    max-width: calc(100vw - 48px);
    position: relative;
    margin-bottom: 24px;
  }

  .main-input {
    width: 100%;
    height: 56px;
    background: var(--input-bg);
    border: 1px solid var(--input-stroke);
    border-radius: 100px;
    padding: 0 56px 0 24px;
    font-family: 'Helvetica', Arial, sans-serif;
    font-size: 16px;
    color: var(--text-dark);
    outline: none;
    box-shadow: 0 4px 14px rgba(0,0,0,0.02);
    transition: box-shadow 0.2s, border-color 0.2s;
  }

  .main-input::placeholder { color: #A8A196; }
  .main-input:focus {
    box-shadow: 0 6px 24px rgba(0,0,0,0.04);
    border-color: #D0C9BE;
  }

  .action-btn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .voice-icon { color: var(--text-muted); }
  .voice-icon svg { width: 20px; height: 20px; }

  .send-icon {
    width: 32px;
    height: 32px;
    display: none;
  }

  .pills {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .pill {
    border: 1px solid var(--pill-border);
    border-radius: 100px;
    padding: 8px 16px;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    font-weight: 400;
    color: var(--text-dark);
    background: transparent;
    cursor: pointer;
    transition: background 0.15s;
  }
  .pill:hover { background: rgba(0,0,0,0.03); }

  /* ── CHAT VIEW ── */
  .chat-messages {
    width: 100%;
    max-width: 840px;
    margin: 0 auto;
    padding: 40px 24px 160px;
    display: flex;
    flex-direction: column;
    gap: 32px;
    overflow-y: auto;
    flex: 1;
  }

  .msg {
    display: flex;
    flex-direction: column;
    font-family: 'Helvetica', Arial, sans-serif;
    font-size: 15.5px;
    line-height: 1.5;
  }

  .msg.user { align-items: flex-end; }
  .msg.ai { align-items: flex-start; }

  .msg.user .bubble {
    background: var(--chat-user-bg);
    border-radius: 16px;
    padding: 14px 20px;
    max-width: 65%;
    color: var(--text-dark);
  }

  .msg.ai .bubble {
    background: transparent;
    padding: 0;
    max-width: 85%;
    color: var(--chat-ai-text);
  }

  .msg.ai .bubble p { margin-bottom: 16px; }
  .msg.ai .bubble p:last-child { margin-bottom: 0; }

  .ai-logo-end {
    width: 26px;
    height: 26px;
    margin-top: 20px;
    object-fit: contain;
    mix-blend-mode: multiply;
    opacity: 0.85;
    animation: fadeIn 0.4s ease;
  }

  /* ── CHAT INPUT BAR ── */
  .chat-input-bar {
    position: absolute;
    bottom: 0;
    left: 0; right: 0;
    display: flex;
    justify-content: center;
    padding: 24px 24px 40px;
    background: linear-gradient(to top, var(--bg) 70%, transparent);
    pointer-events: none;
  }

  .chat-input-wrapper {
    width: 720px;
    max-width: calc(100vw - 48px);
    position: relative;
    pointer-events: auto;
  }

  .chat-input {
    width: 100%;
    height: 56px;
    background: var(--input-bg);
    border: 1px solid var(--input-stroke);
    border-radius: 100px;
    padding: 0 56px 0 24px;
    font-family: 'Helvetica', Arial, sans-serif;
    font-size: 16px;
    color: var(--text-dark);
    outline: none;
    box-shadow: 0 4px 14px rgba(0,0,0,0.02);
  }
  .chat-input::placeholder { color: #A8A196; }

  .chat-send-btn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.15s;
  }
  .chat-send-btn:hover { opacity: 0.8; }

  /* Utilities */
  .typing { display: flex; gap: 5px; padding: 10px 0; }
  .typing span {
    width: 6px; height: 6px;
    background: var(--text-muted);
    border-radius: 50%;
    animation: bounce 1.2s infinite;
  }
  .typing span:nth-child(2) { animation-delay: 0.2s; }
  .typing span:nth-child(3) { animation-delay: 0.4s; }

  .fade-in { animation: fadeIn 0.3s ease; }
  @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  /* ── SIDEBAR STYLES ── */
  #sidebar {
    position: fixed;
    top: 0; left: 0; bottom: 0;
    width: 300px;
    background: var(--sidebar-bg);
    border-right: 1px solid rgba(0,0,0,0.05);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    padding: 24px;
    box-shadow: 4px 0 24px rgba(0,0,0,0.04);
  }
  #sidebar.open { transform: translateX(0); }

  .sidebar-header { margin-bottom: 24px; }
  
  .new-chat-btn {
    background: transparent;
    border: 1px solid var(--text-muted);
    border-radius: 8px;
    padding: 10px 16px;
    color: var(--text-dark);
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    justify-content: center;
    transition: background 0.2s;
  }
  .new-chat-btn:hover { background: rgba(0,0,0,0.04); }

  .search-bar {
    width: 100%;
    padding: 12px 16px;
    border-radius: 100px;
    border: 1px solid var(--input-stroke);
    background: var(--input-bg);
    margin-bottom: 20px;
    font-size: 14px;
    outline: none;
    font-family: 'Helvetica', Arial, sans-serif;
  }

  .chat-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .chat-item {
    padding: 12px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-family: 'Helvetica', Arial, sans-serif;
    color: var(--text-dark);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: background 0.15s;
  }
  .chat-item:hover, .chat-item.active { background: rgba(0,0,0,0.06); }

  #sidebar-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.2);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    z-index: 999;
  }
  #sidebar-overlay.active { opacity: 1; pointer-events: auto; }
</style>
</head>
<body>

<div id="sidebar-overlay" onclick="toggleSidebar()"></div>
<aside id="sidebar">
  <div class="sidebar-header">
    <button class="new-chat-btn" onclick="clickNewChatBtn()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      New Chat
    </button>
  </div>
  <input type="text" class="search-bar" id="search-bar" placeholder="Search chats..." oninput="renderChatList()">
  <div class="chat-list" id="chat-list">
  </div>
</aside>

<nav>
  <div class="nav-left">
    <div class="menu-toggle" onclick="toggleSidebar()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </div>

    <a class="logo" href="#" id="home-logo" onclick="goHome()">
      <img src="logo" alt="Selah Logo">
      Selah
    </a>
    
    <div class="chat-nav-title" id="chat-title" onclick="goHome()">
      <span id="chat-title-text">I am satyam</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </div>
  </div>

  <ul class="nav-links">
    <li><a href="#">Semantic (Plugins)</a></li>
    <li><a href="diagram.html">Diagram</a></li>
    <li><a href="#">Notes</a></li>
    <li><a href="#">About</a></li>
  </ul>
</nav>

<div id="home-view">
  <h1 class="greeting" id="greeting">Hello</h1>

  <div class="input-wrapper">
    <input class="main-input" id="main-input" type="text" placeholder="What's on your mind?" autocomplete="off" />
    
    <button class="action-btn voice-icon" id="home-voice-btn" title="Voice input">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <line x1="10" y1="8" x2="10" y2="16"/>
        <line x1="14" y1="6" x2="14" y2="18"/>
        <line x1="18" y1="10" x2="18" y2="14"/>
        <line x1="6" y1="10" x2="6" y2="14"/>
      </svg>
    </button>
    
    <button class="action-btn send-icon" id="home-send-btn" title="Send">
      <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="16" cy="16" r="16" fill="#111111"/>
        <path d="M16 22V10M16 10L10 16M16 10L22 16" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <div class="pills">
    <button class="pill" onclick="quickPrompt('Learning')">Learning</button>
    <button class="pill" onclick="quickPrompt('Task')">Task</button>
    <button class="pill" onclick="quickPrompt('Relationships')">Relationships</button>
    <button class="pill" onclick="quickPrompt('Purpose')">Purpose</button>
    <button class="pill" onclick="quickPrompt('Health')">Health</button>
  </div>
</div>

<div id="chat-view">
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-bar">
    <div class="chat-input-wrapper">
      <input class="chat-input" id="chat-input" type="text" placeholder="Reply..." autocomplete="off"/>
      
      <button class="chat-send-btn" id="chat-send-btn">
        <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="16" cy="16" r="16" fill="#111111"/>
          <path d="M16 22V10M16 10L10 16M16 10L22 16" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  // ── SAFE LOCAL DATABASE LOGIC ──
  let db;
  try {
    db = JSON.parse(localStorage.getItem('selah_memory'));
    if (!db || !Array.isArray(db.chats)) throw new Error("Corrupted DB");
  } catch (e) {
    db = { chats: [], activeChatId: null };
    localStorage.setItem('selah_memory', JSON.stringify(db));
  }

  function saveDB() {
    localStorage.setItem('selah_memory', JSON.stringify(db));
    renderChatList();
  }

  // Purely handles creating the data, NOT resetting the UI
  function createNewChatData() {
    const newId = 'chat_' + Date.now();
    db.chats.unshift({ id: newId, title: "New Dissection", updatedAt: new Date().toISOString(), messages: [] });
    db.activeChatId = newId;
    saveDB();
    return newId;
  }

  // Called when you actually click the button in the sidebar
  function clickNewChatBtn() {
    createNewChatData();
    goHome();
    toggleSidebar();
  }

  function loadChat(id) {
    db.activeChatId = id;
    saveDB();
    document.getElementById('chat-messages').innerHTML = '';
    const chat = db.chats.find(c => c.id === id);
    
    if(chat && chat.messages.length > 0) {
      document.getElementById('home-view').style.display = 'none';
      document.getElementById('chat-view').style.display = 'flex';
      document.getElementById('home-logo').style.display = 'none';
      document.getElementById('chat-title').style.display = 'flex';
      document.getElementById('chat-title-text').textContent = chat.title;
      
      chat.messages.forEach(msg => appendMessageUI(msg.role, msg.content, false));
      const aiMessages = document.querySelectorAll('.msg.ai');
      if(aiMessages.length > 0) updateAILogoPosition(aiMessages[aiMessages.length - 1]);
    }
    toggleSidebar();
  }

  function renderChatList() {
    const query = document.getElementById('search-bar').value.toLowerCase();
    const list = document.getElementById('chat-list');
    list.innerHTML = '';
    
    db.chats.filter(c => c.title.toLowerCase().includes(query)).forEach(chat => {
      const div = document.createElement('div');
      div.className = `chat-item ${chat.id === db.activeChatId ? 'active' : ''}`;
      div.textContent = chat.title;
      div.onclick = () => loadChat(chat.id);
      list.appendChild(div);
    });
  }

  function toggleSidebar() {
    const sb = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    if (sb.classList.contains('open')) {
      sb.classList.remove('open');
      overlay.classList.remove('active');
    } else {
      sb.classList.add('open');
      overlay.classList.add('active');
      renderChatList();
    }
  }

  // ── UI LOGIC ──
  const hour = new Date().getHours();
  document.getElementById('greeting').textContent = `Good ${hour < 12 ? 'Morning' : hour < 17 ? 'Afternoon' : 'Evening'}`;

  // Initialize DB if completely empty
  if(db.chats.length === 0) createNewChatData();

  const mainInput = document.getElementById('main-input');
  const homeVoiceBtn = document.getElementById('home-voice-btn');
  const homeSendBtn = document.getElementById('home-send-btn');
  const chatInput = document.getElementById('chat-input');
  const homeLogo = document.getElementById('home-logo');
  const chatTitle = document.getElementById('chat-title');
  const chatTitleText = document.getElementById('chat-title-text');
  const sunLogoHTML = `<img class="ai-logo-end" src="logo" alt="Selah Logo">`;

  mainInput.addEventListener('input', () => {
    const hasText = mainInput.value.trim().length > 0;
    homeVoiceBtn.style.display = hasText ? 'none' : 'flex';
    homeSendBtn.style.display = hasText ? 'flex' : 'none';
  });

  mainInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && mainInput.value.trim()) startChat(mainInput.value.trim());
  });

  homeSendBtn.addEventListener('click', () => {
    if (mainInput.value.trim()) startChat(mainInput.value.trim());
  });

  function quickPrompt(topic) {
    mainInput.value = topic;
    mainInput.dispatchEvent(new Event('input'));
    mainInput.focus();
  }

  function escapeHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function appendMessageUI(role, text, isNew = true) {
    const msgs = document.getElementById('chat-messages');
    const msg = document.createElement('div');
    msg.className = `msg ${role} ${isNew ? 'fade-in' : ''}`;

    if (role === 'user') {
      msg.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
    } else {
      const paragraphs = text.split('\n').filter(p => p.trim());
      const pHtml = paragraphs.map(p => `<p>${escapeHtml(p)}</p>`).join('');
      msg.innerHTML = `<div class="bubble">${pHtml}</div>`;
    }

    msgs.appendChild(msg);
    msgs.scrollTop = msgs.scrollHeight;
    return msg;
  }

  function addMessageToDB(role, text) {
    let chat = db.chats.find(c => c.id === db.activeChatId);
    if(!chat) {
      createNewChatData();
      chat = db.chats.find(c => c.id === db.activeChatId);
    }
    
    chat.messages.push({role, content: text});
    chat.updatedAt = new Date().toISOString();
    saveDB();
    
    return appendMessageUI(role, text);
  }

  function updateAILogoPosition(aiMessageNode) {
    const existingLogo = document.querySelector('.ai-logo-end');
    if (existingLogo) existingLogo.remove();
    aiMessageNode.insertAdjacentHTML('beforeend', sunLogoHTML);
  }

  function showTyping() {
    const msgs = document.getElementById('chat-messages');
    const el = document.createElement('div');
    el.className = 'msg ai fade-in';
    el.id = 'typing-indicator';
    el.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`;
    msgs.appendChild(el);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function removeTyping() {
    document.getElementById('typing-indicator')?.remove();
  }

async function getAIResponse(userMessage) {
    try {
      // 1. Grab the full conversation history from your database
      let chat = db.chats.find(c => c.id === db.activeChatId);
      let conversationHistory = [];
      
      if (chat && chat.messages) {
        // Convert your DB roles ('ai', 'user') into Ollama's roles ('assistant', 'user')
        conversationHistory = chat.messages.map(m => ({
          role: m.role === 'ai' ? 'assistant' : 'user',
          content: m.content
        }));
      } else {
        // Fallback just in case
        conversationHistory = [{ role: 'user', content: userMessage }];
      }

      // 2. Send the ENTIRE history to Ollama using the /api/chat endpoint
      const response = await fetch('http://localhost:11434/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'llama3.2:1b', 
          messages: [
            {
              role: 'system',
              content: "Keep your responses precise & pragramatic. You are Selah. You should dissect ideas rather than getting along with fallacies, conjectures, no biases but do empathize. The focus is on root problem and its best solution in the form Your purpose and goal is to be abstract, abstract conceptual knowledge. Strictly, don't provide unnecassary responses and data, neither make it sound intellectual, keep things extremely simple which is a dissection."
            },
            ...conversationHistory // Unpacks the whole history here!
          ],
          stream: false,
          options: { temperature: 0.7, num_predict: 100 }
        })
      });

      if (!response.ok) throw new Error('Ollama connection failed');
      const data = await response.json();
      
      // The /api/chat endpoint returns the text inside data.message.content
      return data.message.content; 
    } catch (error) {
      console.error("Connection Error:", error);
      return "Oopsie! I couldn't connect to Ollama.";
    }
  }

  async function processChat(text) {
    addMessageToDB('user', text);
    showTyping();

    const reply = await getAIResponse(text); 
    
    removeTyping();
    const aiNode = addMessageToDB('ai', reply);
    updateAILogoPosition(aiNode);
  }

  async function startChat(prompt) {
    // ── THE FIX IS HERE ──
    let chat = db.chats.find(c => c.id === db.activeChatId);
    if(!chat || chat.messages.length > 0) {
      // Safely create data without triggering goHome()
      createNewChatData(); 
      chat = db.chats.find(c => c.id === db.activeChatId);
    }
    
    let title = prompt.split(' ').slice(0, 4).join(' ');
    if(prompt.split(' ').length > 4) title += '...';
    chat.title = title;
    saveDB();

    document.getElementById('home-view').style.display = 'none';
    document.getElementById('chat-view').style.display = 'flex';
    homeLogo.style.display = 'none';
    chatTitle.style.display = 'flex';
    chatTitleText.textContent = title;

    await processChat(prompt);
  }

  document.getElementById('chat-send-btn').addEventListener('click', () => {
    const text = chatInput.value.trim();
    if (text) {
      chatInput.value = '';
      processChat(text);
    }
  });

  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const text = chatInput.value.trim();
      if (text) {
        chatInput.value = '';
        processChat(text);
      }
    }
  });

  function goHome() {
    document.getElementById('home-view').style.display = 'flex';
    document.getElementById('chat-view').style.display = 'none';
    document.getElementById('chat-messages').innerHTML = '';
    homeLogo.style.display = 'flex';
    chatTitle.style.display = 'none';

    mainInput.value = '';
    homeVoiceBtn.style.display = 'flex';
    homeSendBtn.style.display = 'none';
    
    db.activeChatId = null; 
    saveDB();
  }
</script>
</body>
</html>